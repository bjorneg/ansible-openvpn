---

- name: Ensure OpenVPN is installed
  apt:
    name: openvpn
    state: present
    install_recommends: False

- name: Fill default values for connection definitions
  set_fact:
    openvpn_connections: "{{ lookup('template', './update-connection-defaults.j2') }}"

#- debug: var=openvpn_connections

- name: Generate OpenVPN configurations
  template:
    src: 'etc/openvpn/openvpn.conf.j2'
    dest: '/etc/openvpn/{{ item.name|replace(" ", "_") }}.conf'
    owner: 'root'
    group: 'root'
    mode: '0600'
  with_items: [ '{{ openvpn_connections }}' ]
  notify: [ 'Restart OpenVPN' ]


- name: Remove OpenVPN server configurations if requested
  file:
    dest: '/etc/openvpn/{{ item.name }}.conf'
    state: 'absent'
  with_items: [ '{{ openvpn_connections }}' ]
  notify: [ 'Restart OpenVPN' ]
  when: item.name|default and item.delete|default

- name: Ensure OpenVPN service is enabled
  service:
    name: openvpn
    enabled: True

